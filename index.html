<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="××¢×§×‘ ×©×¢×•×ª">
    <meta name="theme-color" content="#4f46e5" id="metaThemeColor">
    <title>××¢×§×‘ ×©×¢×•×ª ××§×¦×•×¢×™</title>
    
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js" async defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <link rel="manifest" href="manifest.json">
    
    <style>
        :root {
            --primary: #4f46e5; --primary-hover: #4338ca; --primary-light: #e0e7ff;
            --bg-color: #f3f4f6; --card-bg: #ffffff; --text-main: #1f2937;
            --text-muted: #6b7280; --border-color: #e5e7eb; --success: #10b981;
            --danger: #ef4444; --shadow: 0 4px 6px -1px rgba(0,0,0,0.1); --radius: 16px;
        }
        [data-theme="dark"] {
            --primary: #818cf8; --primary-hover: #6366f1; --primary-light: #3730a3;
            --bg-color: #111827; --card-bg: #1f2937; --text-main: #f9fafb;
            --text-muted: #9ca3af; --border-color: #374151; --shadow: 0 4px 6px -1px rgba(0,0,0,0.5);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: system-ui, -apple-system, sans-serif; background-color: var(--bg-color); color: var(--text-main); min-height: 100vh; padding: 15px; padding-bottom: 90px; transition: 0.3s; }
        .container { max-width: 900px; margin: 0 auto; }
        
        .header { background: var(--card-bg); padding: 20px; border-radius: var(--radius); box-shadow: var(--shadow); margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        .header h1 { font-size: 22px; color: var(--primary); }
        .theme-toggle { background: none; border: 2px solid var(--border-color); border-radius: 50%; width: 40px; height: 40px; font-size: 20px; cursor: pointer; color: var(--text-main); transition: 0.3s; }
        
        .clock-panel { background: var(--card-bg); border-radius: var(--radius); padding: 20px; text-align: center; box-shadow: var(--shadow); margin-bottom: 20px; border: 2px solid var(--primary-light); }
        .timer-display { font-size: 36px; font-weight: bold; font-variant-numeric: tabular-nums; color: var(--text-main); margin: 10px 0; }
        
        .tabs { display: flex; background: var(--card-bg); border-radius: var(--radius); padding: 8px; margin-bottom: 20px; box-shadow: var(--shadow); gap: 8px; overflow-x: auto;}
        .tab { flex: 1; padding: 12px; text-align: center; cursor: pointer; background: transparent; border: none; font-size: 15px; font-weight: bold; color: var(--text-muted); border-radius: 8px; white-space: nowrap; transition: 0.2s;}
        .tab.active { background: var(--primary-light); color: var(--primary); }
        .content { background: var(--card-bg); border-radius: var(--radius); padding: 20px; box-shadow: var(--shadow); }
        .tab-content { display: none; animation: fadeIn 0.3s; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        button { cursor: pointer; font-family: inherit; }
        .btn { padding: 10px 20px; border-radius: 8px; border: none; font-weight: bold; font-size: 15px; transition: 0.2s; width: 100%; margin-top: 5px;}
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-outline { background: transparent; border: 1px solid var(--border-color); color: var(--text-main); }
        
        input, select { width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-color); color: var(--text-main); font-size: 16px; margin-top: 5px; }
        
        .nav-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .nav-header button { width: auto; padding: 5px 15px; }
        .month-calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; margin-top: 15px; user-select: none; }
        .day-header { text-align: center; font-weight: bold; font-size: 13px; color: var(--text-muted); padding: 5px 0; }
        .day-cell { aspect-ratio: 1; border: 1px solid var(--border-color); border-radius: 8px; padding: 5px; cursor: pointer; display: flex; flex-direction: column; justify-content: space-between; background: var(--card-bg); position: relative; transition: 0.1s;}
        .day-cell.today { border: 2px solid var(--primary); }
        .day-cell.has-hours { background: var(--primary-light); border-color: transparent; }
        .has-note-dot { position: absolute; top: 4px; left: 4px; width: 6px; height: 6px; background: var(--danger); border-radius: 50%; }
        .date-info { display: flex; flex-direction: column; gap: 2px; }
        .gregorian-date { font-weight: bold; font-size: 14px; }
        .hebrew-date { font-size: 10px; color: var(--primary); }
        .hours-display { font-size: 11px; font-weight: bold; text-align: center; color: var(--primary); }
        
        .jump-bar { display: flex; gap: 10px; background: var(--bg-color); padding: 10px; border-radius: 8px; border: 1px solid var(--border-color); margin-bottom: 15px; align-items: center;}
        .jump-bar input { margin: 0; padding: 8px; flex: 1; }
        .jump-bar button { width: auto; margin: 0; padding: 8px 15px; }

        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 1000; align-items: center; justify-content: center; padding: 15px; }
        .modal.active { display: flex; }
        .modal-content { background: var(--card-bg); padding: 20px; border-radius: var(--radius); width: 100%; max-width: 450px; max-height: 90vh; overflow-y: auto; box-shadow: var(--shadow); position: relative;}
        .modal-buttons { display: flex; gap: 10px; margin-top: 20px; }
        
        .modal-nav-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; background: var(--primary-light); padding: 10px; border-radius: 8px; }
        .modal-nav-header button { background: none; border: none; font-size: 18px; color: var(--primary); cursor: pointer; padding: 0 10px; }
        
        .setting-group { background: var(--bg-color); padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid var(--border-color); }
        .date-range-picker { display: none; background: var(--card-bg); padding: 10px; border-radius: 8px; margin-top: 10px; border: 1px dashed var(--primary); }
        
        .bonus-row { display: flex; gap: 5px; align-items: center; margin-top: 5px; }
        .bonus-row input[type="text"] { flex: 2; }
        .bonus-row input[type="number"] { flex: 1; }
        
        .time-inputs { display: flex; gap: 10px; margin-bottom: 15px; }
        .time-inputs > div { flex: 1; }
        .time-inputs input[type="time"] { padding: 10px; font-size: 16px; text-align: center; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div>
                <h1>ğŸ“Š ××¢×§×‘ ×©×¢×•×ª Pro</h1>
                <p style="color: var(--text-muted); font-size: 14px;">××¤×œ×™×§×¦×™×” ××™×©×™×ª + ×’×™×‘×•×™ ×¢× ×Ÿ</p>
            </div>
            <button class="theme-toggle" onclick="toggleTheme()" id="themeBtn">ğŸŒ™</button>
        </div>

        <div class="clock-panel">
            <h3 style="margin-bottom: 10px;">â° ×©×¢×•×Ÿ × ×•×›×—×•×ª "×œ×™×™×‘"</h3>
            <div class="timer-display" id="liveTimer">00:00:00</div>
            <button id="clockBtn" class="btn btn-primary" style="width: 100%; max-width: 250px;" onclick="handleClock()">â–¶ï¸ ×”×ª×—×œ ××©××¨×ª</button>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('calendar')">ğŸ“… ×™×•××Ÿ</button>
            <button class="tab" onclick="switchTab('reports')">ğŸ“ˆ ×“×•×—×•×ª ×•×¡×™×›×•××™×</button>
            <button class="tab" onclick="switchTab('settings')">âš™ï¸ ×”×’×“×¨×•×ª ×•×’×™×‘×•×™</button>
        </div>

        <div class="content">
            <div id="calendar" class="tab-content active">
                <div class="jump-bar">
                    <button class="btn btn-primary" style="background: var(--primary-light); color: var(--primary);" onclick="jumpToToday()">×”×™×•×</button>
                    <input type="date" id="jumpDateInput">
                    <button class="btn btn-outline" style="border-color: var(--primary); color: var(--primary);" onclick="jumpToDate()">×§×¤×•×¥</button>
                </div>

                <div class="setting-group" style="padding: 10px; text-align: center;">
                    <strong>âœ¨ ×¤×¢×•×œ×” ××”×™×¨×” ×œ×ª×§×•×¤×”:</strong>
                    <button class="btn btn-primary" style="margin-top: 10px;" onclick="openMagicModal('hours')">â• ×”×—×œ×ª ×©×¢×•×ª ×§×‘×•×¢×•×ª ×œ×ª×§×•×¤×”</button>
                    <button class="btn btn-success" style="margin-top: 10px;" onclick="openMagicModal('profit')">ğŸ’° ×”×•×¡×¤×ª ×¨×•×•×— ×§×‘×•×¢ ×œ×ª×§×•×¤×”</button>
                </div>

                <div class="nav-header">
                    <button class="btn btn-outline" onclick="navigateMonth(-1)">â—€ ×§×•×“×</button>
                    <h2 id="monthViewTitle" style="font-size: 18px;"></h2>
                    <button class="btn btn-outline" onclick="navigateMonth(1)">×”×‘× â–¶</button>
                </div>
                <div id="monthViewContent"></div>
            </div>

            <div id="reports" class="tab-content">
                <div class="setting-group">
                    <label style="font-weight: bold;">ğŸ“… ×¡× ×Ÿ ×’×¨×¤×™× ×œ×¤×™ ×”×ª×§×•×¤×”:</label>
                    <select id="chartPeriod" onchange="toggleChartCustom()">
                        <option value="7">7 ×™××™× ××—×¨×•× ×™×</option>
                        <option value="14" selected>14 ×™××™× ××—×¨×•× ×™×</option>
                        <option value="month">×”×—×•×“×© ×”× ×•×›×—×™</option>
                        <option value="lastMonth">×—×•×“×© ×§×•×“×</option>
                        <option value="custom">×‘×™×Ÿ ×ª××¨×™×›×™× ××™×©×™×™×...</option>
                    </select>
                    
                    <div id="chartCustomDates" class="date-range-picker">
                        <label>××ª××¨×™×š:</label><input type="date" id="chartStart">
                        <label>×¢×“ ×ª××¨×™×š:</label><input type="date" id="chartEnd">
                    </div>
                    <button class="btn btn-primary" onclick="updateReports(false)">×¨×¢× ×Ÿ ×’×¨×¤×™×</button>
                </div>

                <div id="reportSummary" style="display: flex; gap:10px; margin-bottom: 20px;"></div>

                <div class="setting-group">
                    <h3 style="text-align: center; font-size: 16px; margin-bottom: 10px;">ğŸ“Š ×”×©×•×•××ª ×¨×•×•×—×™× (×—×•×“×©×™/×©×‘×•×¢×™)</h3>
                    <div style="display: flex; gap: 5px; align-items: flex-end; flex-wrap: wrap;">
                        <div style="flex: 1; min-width: 120px;">
                            <label style="font-size: 12px;">×§×‘×¥ ×œ×¤×™:</label>
                            <select id="compGrouping" onchange="toggleCompSelectors(); updateComparisonChart();">
                                <option value="month">×—×•×“×©×™×</option>
                                <option value="week">×©×‘×•×¢×•×ª ×©×œ ×—×•×“×© × ×‘×—×¨</option>
                            </select>
                        </div>
                        <div id="compMonthArea" style="flex: 1; min-width: 120px; display: none;">
                            <label style="font-size: 12px;">×‘×—×¨ ×—×•×“×© ×œ×”×©×•×•××”:</label>
                            <input type="month" id="compMonthSelector" onchange="updateComparisonChart()" style="padding: 10px; font-size: 13px;">
                        </div>
                    </div>
                    <div style="position: relative; height: 200px; width: 100%; margin-top: 15px;">
                        <canvas id="comparisonChart"></canvas>
                    </div>
                </div>

                <div class="setting-group">
                    <h3 style="text-align: center; font-size: 16px; margin-bottom: 10px;">â° ×©×¢×•×ª ×¢×‘×•×“×”</h3>
                    <div style="position: relative; height: 200px; width: 100%;">
                        <canvas id="hoursChart"></canvas>
                    </div>
                </div>

                <div class="setting-group" style="border-color: var(--success);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h3 style="font-size: 16px; color: var(--success); margin: 0;">ğŸ’° ×”×›× ×¡×•×ª</h3>
                        <select id="profitFilter" onchange="updateReports(true)" style="width: auto; padding: 5px; margin: 0; font-size: 13px;">
                            <option value="all">×¡×”"×› (×©×›×¨ + ×ª×•×¡×¤×•×ª)</option>
                            <option value="base">×¨×§ ×©×›×¨ ××©×¢×•×ª ×¢×‘×•×“×”</option>
                            <option value="bonus">×¨×§ ×ª×•×¡×¤×•×ª ×•×‘×•× ×•×¡×™×</option>
                        </select>
                    </div>
                    <div style="position: relative; height: 200px; width: 100%;">
                        <canvas id="profitChart"></canvas>
                    </div>
                </div>

                <div id="monthlyArchiveContainer" style="margin-top: 30px;"></div>
            </div>

            <div id="settings" class="tab-content">
                
                <div class="setting-group" id="installContainer" style="display: none; border-color: var(--success);">
                    <label style="font-weight: bold; color: var(--success);">ğŸ“± ×”×ª×§× ×ª ×”××¤×œ×™×§×¦×™×”</label>
                    <p style="font-size: 13px; margin-top: 5px; color: var(--text-muted);">×”×ª×§×Ÿ ××ª ×”××¢×¨×›×ª ×¢×œ ×”××›×©×™×¨ ×©×œ×š ×œ×’×™×©×” ××”×™×¨×” ×•×—×•×•×™×” ××œ××” ×œ×œ× ×“×¤×“×¤×Ÿ.</p>
                    <button id="installBtn" class="btn btn-success" style="margin-top: 10px;">â¬‡ï¸ ×”×•×¨×“ ×œ××›×©×™×¨ ×¢×›×©×™×•</button>
                </div>

                <div class="setting-group" style="border-color: var(--primary);">
                    <label style="font-weight: bold; color: var(--primary);">ğŸŒ ×¡× ×›×¨×•×Ÿ ×¢× ×Ÿ (Google Drive)</label>
                    <button id="authBtn" class="btn btn-outline" style="border-color: var(--primary); color: var(--primary); margin-top: 10px;">ğŸ”— ×—×‘×¨ ×—×©×‘×•×Ÿ ×’×•×’×œ ×œ×¡× ×›×¨×•×Ÿ</button>
                    
                    <div id="syncInfo" style="display:none; margin-top: 10px; text-align: center;">
                        <div style="color: var(--success); font-size: 12px; font-weight: bold;">××—×•×‘×¨ ×•××¡×•× ×›×¨×Ÿ ×œ×—×©×‘×•×Ÿ ×’×•×’×œ âœ…</div>
                        <div id="userAccountInfo" style="font-size: 11px; color: var(--text-muted); margin-top: 3px;"></div>
                        <button class="btn btn-outline" style="width: auto; padding: 6px 12px; font-size: 12px; margin: 10px auto 0; border-color: var(--primary); color: var(--primary); display: block;" onclick="manualSyncNow()">ğŸ”„ ×‘×¦×¢ ×¡× ×›×¨×•×Ÿ ×™×“× ×™ ×¢×›×©×™×•</button>
                        
                        <button class="btn btn-outline" style="width: auto; font-size: 13px; color: var(--danger); border-color: var(--danger); margin-top: 15px; display: block; margin-left: auto; margin-right: auto; padding: 6px 15px;" onclick="disconnectGoogle()">ğŸ”“ × ×ª×§ ×—×©×‘×•×Ÿ ×’×•×’×œ</button>
                    </div>
                </div>

                <div class="setting-group">
                    <label style="font-weight: bold;">ğŸ’° × ×™×”×•×œ ×©×›×¨ ×•×ª×¢×¨×™×¤×™×</label>
                    <div style="margin-top: 15px;">
                        <label style="font-size: 14px;">×©×›×¨ ×©×¢×ª×™ ×‘×¨×™×¨×ª ××—×“×œ (â‚ª):</label>
                        <input type="number" id="defaultRate" placeholder="×œ××©×œ: 50" onchange="saveSettings()">
                        <div id="currentRateDisplay" style="font-size: 13px; margin-top: 8px; color: var(--primary); font-weight: bold; padding: 5px; background: var(--primary-light); border-radius: 6px; text-align: center;"></div>
                    </div>
                    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px dashed var(--border-color);">
                        <label style="font-size: 14px;">×©×™× ×•×™ ×ª×¢×¨×™×£ ×–×× ×™ ×œ×ª×§×•×¤×”:</label>
                        <button class="btn btn-outline" style="border-color:var(--primary); color:var(--primary); margin-top: 10px;" onclick="openMagicModal('rate')">ğŸ’° ×”×’×“×¨ ×ª×¢×¨×™×£ ××©×ª× ×”</button>
                    </div>
                </div>

                <div class="setting-group">
                    <label style="font-weight: bold;">â±ï¸ ×©×¢×•×ª × ×•×¡×¤×•×ª</label>
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; margin-top: 10px;">
                        <input type="checkbox" id="calcOvertime" onchange="saveSettings()" style="width: auto;">
                        ×—×©×‘ ××•×˜×•××˜×™×ª 125% ×•-150% (××¢×œ 8 ×©×¢×•×ª)
                    </label>
                </div>

                <div class="setting-group">
                    <label style="font-weight: bold;">ğŸ’¾ × ×ª×•× ×™× ×•×™×™×¦×•×</label>
                    <button class="btn btn-outline" style="border-color: #10b981; color: #10b981; margin-top: 10px;" onclick="exportToCSV()">ğŸ“Š ×™×™×¦×•× ×œ××§×¡×œ (CSV)</button>
                    <button class="btn btn-outline" style="margin-top: 10px;" onclick="backupData()">ğŸ“¥ ×”×•×¨×“ ×§×•×‘×¥ ×’×™×‘×•×™ × ×ª×•× ×™×</button>
                    <div style="margin-top: 15px; padding-top: 10px; border-top: 1px dashed var(--border-color);">
                        <label style="font-size: 13px; color: var(--text-muted);">×©×—×–×•×¨ ××’×™×‘×•×™ (×‘×—×¨ ×§×•×‘×¥ json):</label>
                        <input type="file" accept=".json" onchange="restoreData(event)">
                    </div>
                </div>

                <div class="setting-group" style="border-color: var(--danger);">
                    <label style="font-weight: bold; color: var(--danger);">ğŸ—‘ï¸ ××—×™×§×ª × ×ª×•× ×™× ×—×›××”</label>
                    <select id="deleteRange" onchange="toggleDeleteCustom()">
                        <option value="">-- ×‘×—×¨ ×ª×§×•×¤×” ×œ××—×™×§×” --</option>
                        <option value="today">××—×§ ××ª ×”×™×•×</option>
                        <option value="week">××—×§ ××ª ×”×©×‘×•×¢ ×”× ×•×›×—×™</option>
                        <option value="month">××—×§ ××ª ×”×—×•×“×© ×”× ×•×›×—×™</option>
                        <option value="lastMonth">×—×•×“×© ×§×•×“×</option>
                        <option value="custom">×‘×—×¨ ×ª××¨×™×›×™× ×œ××—×™×§×”...</option>
                        <option value="all">××—×§ ××ª ×›×œ ×”× ×ª×•× ×™× ×‘××¤×œ×™×§×¦×™×”!</option>
                    </select>
                    
                    <div id="deleteCustomDates" class="date-range-picker">
                        <label>××ª××¨×™×š:</label><input type="date" id="delStart">
                        <label>×¢×“ ×ª××¨×™×š:</label><input type="date" id="delEnd">
                    </div>
                    <button class="btn btn-danger" onclick="executeSmartDelete()">××—×§ × ×ª×•× ×™× ×œ×¦××™×ª×•×ª</button>
                </div>
            </div>
        </div>
    </div>

    <div id="hoursModal" class="modal">
        <div class="modal-content">
            <div class="modal-nav-header">
                <button onclick="navigateModal(-1)">â—€</button>
                <div style="text-align: center;">
                    <h3 id="modalTitle" style="color: var(--primary); margin: 0; font-size: 18px;"></h3>
                    <p id="modalSubtitle" style="font-size: 12px; color: var(--text-main); margin: 0;"></p>
                </div>
                <button onclick="navigateModal(1)">â–¶</button>
            </div>
            <div class="time-inputs">
                <div><label>×›× ×™×¡×”:</label><input type="time" id="startTimeInput" onchange="calcHoursFromTimes()"></div>
                <div><label>×¡×™×•×:</label><input type="time" id="endTimeInput" onchange="calcHoursFromTimes()"></div>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                <label>×¡×”"×› ×©×¢×•×ª:</label><button class="btn btn-outline" style="width: auto; padding: 4px 10px; font-size: 12px;" onclick="copyYesterdayHours()">ğŸ” ×××ª××•×œ</button>
            </div>
            <input type="number" id="hoursInput" step="0.25">
            <label>×ª×¢×¨×™×£ ×©×¢×ª×™ (â‚ª):</label><input type="number" id="dayRateInput">
            <div id="bonusesContainer" style="margin-top: 15px; border-top: 1px dashed var(--border-color); padding-top: 10px;"></div>
            <button class="btn btn-outline" onclick="addBonusRow()">+ ×”×•×¡×£ ×©×•×¨×ª ×¨×•×•×—</button>
            <input type="text" id="dailyNote" placeholder="×”×¢×¨×”...">
            <div class="modal-buttons">
                <button class="btn btn-primary" onclick="saveDailyData(true)">ğŸ’¾ ×©××•×¨</button>
                <button class="btn btn-outline" onclick="closeModals()">×‘×™×˜×•×œ</button>
            </div>
        </div>
    </div>

    <div id="multiDateModal" class="modal">
        <div class="modal-content">
            <h3 id="multiModalTitle" style="color: var(--primary); margin-bottom: 15px;"></h3>
            <div id="multiModalInputArea"></div>
            
            <label style="font-weight: bold; margin-top:15px; display:block;">×¢×œ ××™×œ×• ×ª××¨×™×›×™× ×œ×”×—×™×œ?</label>
            <select id="multiDateRange" onchange="toggleMultiCustom()">
                <option value="today">×¨×§ ×”×™×•×</option>
                <option value="week">×”×©×‘×•×¢</option>
                <option value="month">×”×—×•×“×©</option>
                <option value="lastMonth">×—×•×“×© ×§×•×“×</option>
                <option value="custom">××™×©×™...</option>
            </select>
            <div id="multiCustomDates" class="date-range-picker">
                <label>×:</label><input type="date" id="multiStart">
                <label>×¢×“:</label><input type="date" id="multiEnd">
            </div>
            <div class="modal-buttons">
                <button class="btn btn-primary" onclick="executeMultiAction()">×‘×¦×¢</button>
                <button class="btn btn-outline" onclick="closeModals()">×‘×™×˜×•×œ</button>
            </div>
        </div>
    </div>

    <script>
        // --- PWA Installation Logic ---
        let deferredPrompt;
        const installContainer = document.getElementById('installContainer');
        const installBtn = document.getElementById('installBtn');

        window.addEventListener('beforeinstallprompt', (e) => {
            // Prevent the mini-infobar from appearing on mobile
            e.preventDefault();
            // Stash the event so it can be triggered later.
            deferredPrompt = e;
            // Update UI notify the user they can install the PWA
            installContainer.style.display = 'block';
        });

        installBtn.addEventListener('click', async () => {
            if (deferredPrompt) {
                // Show the install prompt
                deferredPrompt.prompt();
                // Wait for the user to respond to the prompt
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') {
                    installContainer.style.display = 'none';
                }
                deferredPrompt = null;
            }
        });

        window.addEventListener('appinstalled', () => {
            // Hide the app-provided install promotion
            installContainer.style.display = 'none';
            deferredPrompt = null;
        });

        // Register Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js').then((reg) => {
                    console.log('Service Worker registered successfully.');
                }).catch((err) => {
                    console.log('Service Worker registration failed: ', err);
                });
            });
        }

        // --- Google Sync Core ---
        const CLIENT_ID = '57616527068-9ogg9tnmgcku8icu5bjkvd7e48b9hujs.apps.googleusercontent.com';
        const SCOPES = 'https://www.googleapis.com/auth/drive.appdata https://www.googleapis.com/auth/userinfo.email';
        let accessToken = null;
        let tokenClient = null;

        function initGoogleDrive() {
            try {
                if (typeof google === 'undefined' || !google.accounts) {
                    setTimeout(initGoogleDrive, 500); return;
                }
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: CLIENT_ID, scope: SCOPES,
                    callback: (resp) => {
                        if (resp.error) return;
                        accessToken = resp.access_token;
                        localStorage.setItem('syncEnabled', 'true');
                        document.getElementById('syncInfo').style.display = 'block';
                        document.getElementById('authBtn').style.display = 'none';
                        fetchUserInfo();
                        loadFromDrive();
                    },
                });
                
                document.getElementById('authBtn').onclick = () => tokenClient.requestAccessToken();
                
                // ×—×™×‘×•×¨ ××•×˜×•××˜×™ ×•×©×§×˜ ××•×ª×× ×œ× ×™×™×“
                if (localStorage.getItem('syncEnabled') === 'true') {
                    setTimeout(() => { tokenClient.requestAccessToken({ prompt: '' }); }, 1500);
                }
            } catch (e) { console.error("Drive failed", e); }
        }

        async function fetchUserInfo() {
            if (!accessToken) return;
            try {
                const resp = await fetch('https://www.googleapis.com/oauth2/v3/userinfo', { headers: { 'Authorization': `Bearer ${accessToken}` } });
                const info = await resp.json();
                if (info.email) document.getElementById('userAccountInfo').innerText = `×—×©×‘×•×Ÿ ××—×•×‘×¨: ${info.email}`;
            } catch (e) {}
        }

        function disconnectGoogle() {
            if (confirm('×œ× ×ª×§ ××ª ×”×—×©×‘×•×Ÿ ×•×œ×‘×˜×œ ×¡× ×›×¨×•×Ÿ ××•×˜×•××˜×™?')) {
                localStorage.removeItem('syncEnabled');
                location.reload();
            }
        }

        async function saveToDrive() {
            if (!accessToken) return;
            const currentTs = parseInt(localStorage.getItem('dbTimestamp')) || Date.now();
            const content = JSON.stringify({ workData: getWorkData(), settings: getSettings(), timestamp: currentTs });
            try {
                const listResp = await fetch(`https://www.googleapis.com/drive/v3/files?q=name='moneytime_db.json'&spaces=appDataFolder`, { headers: { 'Authorization': `Bearer ${accessToken}` } });
                const list = await listResp.json();
                let fileId = null;
                
                if (list.files && list.files.length > 0) { 
                    fileId = list.files[0].id; 
                } else {
                    const createResp = await fetch('https://www.googleapis.com/drive/v3/files', {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${accessToken}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name: 'moneytime_db.json', parents: ['appDataFolder'] })
                    });
                    const created = await createResp.json();
                    fileId = created.id;
                }
                
                await fetch(`https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=media`, {
                    method: 'PATCH',
                    headers: { 'Authorization': `Bearer ${accessToken}`, 'Content-Type': 'application/json' },
                    body: content
                });
            } catch (e) { console.error("Save failed", e); }
        }

        async function loadFromDrive() {
            if (!accessToken) return;
            try {
                const listResp = await fetch(`https://www.googleapis.com/drive/v3/files?q=name='moneytime_db.json'&spaces=appDataFolder`, { headers: { 'Authorization': `Bearer ${accessToken}` } });
                const list = await listResp.json();
                if (list.files && list.files.length > 0) {
                    const fileId = list.files[0].id;
                    const getResp = await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`, { headers: { 'Authorization': `Bearer ${accessToken}` } });
                    const cloudData = await getResp.json();
                    
                    const cloudTs = cloudData.timestamp || 0;
                    const localTs = parseInt(localStorage.getItem('dbTimestamp')) || 0;
                    
                    if (cloudTs > localTs || localTs === 0) {
                        localStorage.setItem('workData', JSON.stringify(cloudData.workData || {}));
                        if (cloudData.settings) localStorage.setItem('settings', JSON.stringify(cloudData.settings));
                        localStorage.setItem('dbTimestamp', cloudTs);
                        loadSettings(); renderMonthView(); updateReports(true);
                    } else if (localTs > cloudTs) {
                        saveToDrive();
                    }
                }
            } catch (e) { console.error("Load failed", e); }
        }

        async function manualSyncNow() {
            if (!accessToken) return;
            const btn = event.target; btn.innerText = "â³ ××¡× ×›×¨×Ÿ..."; btn.disabled = true;
            try { 
                await loadFromDrive(); 
                await saveToDrive(); 
                alert("×”×¡× ×›×¨×•×Ÿ ××•×œ ×”×¢× ×Ÿ ×”×•×©×œ× ×‘×”×¦×œ×—×”! âœ…"); 
            }
            catch (err) { alert("×©×’×™××” ×‘×¡× ×›×¨×•×Ÿ."); }
            finally { btn.innerText = "ğŸ”„ ×‘×¦×¢ ×¡× ×›×¨×•×Ÿ ×™×“× ×™ ×¢×›×©×™×•"; btn.disabled = false; }
        }

        // --- ×”×× ×•×¢ ×”×¢×‘×¨×™ ×”××ª×•×§×Ÿ ×•×”××“×•×™×§ ×”××‘×•×¡×¡ ×¢×œ ×”×“×¤×“×¤×Ÿ ---
        const HebrewCal = (function() {
            function gematriya(num) {
                const ones=['','×','×‘','×’','×“','×”','×•','×–','×—','×˜'], tens=['','×™','×›','×œ','×','× ','×¡','×¢','×¤','×¦'];
                if(num===15) return '×˜×´×•'; if(num===16) return '×˜×´×–';
                let res = (tens[Math.floor((num%100)/10)] || '') + (ones[num%10] || '');
                return res.length>1 ? res.slice(0,-1)+'×´'+res.slice(-1) : res+'×³';
            }
            function format(gDate) {
                try {
                    const formatter = new Intl.DateTimeFormat('he-IL-u-ca-hebrew', { day: 'numeric', month: 'long' });
                    const parts = formatter.formatToParts(gDate);
                    let dayStr = '', monthName = '';
                    for (let p of parts) {
                        if (p.type === 'day') {
                            const num = parseInt(p.value, 10);
                            dayStr = isNaN(num) ? p.value : gematriya(num);
                        }
                        if (p.type === 'month') monthName = p.value;
                    }
                    return dayStr + ' ' + monthName;
                } catch(e) {
                    return ''; 
                }
            }
            return { format };
        })();

        let currentDate = new Date(), selectedDate = null, hoursChart, profitChart, comparisonChart, multiActionType = '', timerInterval = null;

        document.addEventListener('DOMContentLoaded', () => {
            if(localStorage.getItem('theme')==='dark') toggleTheme(true);
            const now = new Date();
            document.getElementById('compMonthSelector').value = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
            loadSettings(); initClock(); renderMonthView(); updateReports(true); initGoogleDrive();
        });

        function toggleTheme() { const d = document.documentElement.getAttribute('data-theme') !== 'dark'; document.documentElement.setAttribute('data-theme', d ? 'dark' : 'light'); localStorage.setItem('theme', d ? 'dark' : 'light'); document.getElementById('themeBtn').textContent = d ? 'â˜€ï¸' : 'ğŸŒ™'; }
        
        function getWorkData() { return JSON.parse(localStorage.getItem('workData')) || {}; }
        
        function setWorkData(data) { 
            localStorage.setItem('workData', JSON.stringify(data)); 
            localStorage.setItem('dbTimestamp', Date.now());
        }
        
        function getSettings() { const s = JSON.parse(localStorage.getItem('settings')) || {}; return { defaultRate: parseFloat(s.defaultRate) || 0, calcOvertime: s.calcOvertime || false }; }
        
        function saveSettings() {
            const val = parseFloat(document.getElementById('defaultRate').value) || 0;
            localStorage.setItem('settings', JSON.stringify({ defaultRate: val, calcOvertime: document.getElementById('calcOvertime').checked }));
            localStorage.setItem('dbTimestamp', Date.now());
            updateRateDisplay(val); updateReports(true); saveToDrive();
        }
        
        function loadSettings() {
            const s = getSettings(); document.getElementById('defaultRate').value = s.defaultRate || '';
            document.getElementById('calcOvertime').checked = s.calcOvertime || false; updateRateDisplay(s.defaultRate);
        }
        
        function updateRateDisplay(rate) { document.getElementById('currentRateDisplay').innerText = rate > 0 ? `×©×›×¨ ×©×¢×ª×™ × ×•×›×—×™: â‚ª${rate}` : "×œ× ×”×•×’×“×¨ ×©×›×¨ ×§×‘×•×¢ âš ï¸"; }
        function formatDateKey(date) { return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`; }

        function calcDailyProfitDetails(hours, rate, bonuses = []) {
            let base = 0; const s = getSettings();
            if (s.calcOvertime && hours > 8) {
                const h125 = Math.min(hours - 8, 2), h150 = Math.max(hours - 10, 0);
                base = (8 * rate) + (h125 * rate * 1.25) + (h150 * rate * 1.5);
            } else { base = hours * rate; }
            const bonTotal = (bonuses || []).reduce((sum, b) => sum + (parseFloat(b.amount) || 0), 0);
            return { base, bonus: bonTotal, total: base + bonTotal };
        }

        function renderMonthView() {
            const y = currentDate.getFullYear(), m = currentDate.getMonth(); const names = ['×™× ×•××¨','×¤×‘×¨×•××¨','××¨×¥','××¤×¨×™×œ','×××™','×™×•× ×™','×™×•×œ×™','××•×’×•×¡×˜','×¡×¤×˜××‘×¨','××•×§×˜×•×‘×¨','× ×•×‘××‘×¨','×“×¦××‘×¨'];
            document.getElementById('monthViewTitle').textContent = `${names[m]} ${y}`;
            const grid = document.getElementById('monthViewContent'); grid.className = 'month-calendar'; grid.innerHTML = '';
            const first = new Date(y, m, 1).getDay(), days = new Date(y, m+1, 0).getDate(), data = getWorkData();
            
            ['×','×‘','×’','×“','×”','×•','×©'].forEach(d => {
                const header = document.createElement('div');
                header.className = 'day-header'; header.innerText = d + "'";
                grid.appendChild(header);
            });
            
            for(let i=0; i<first; i++) grid.appendChild(document.createElement('div'));
            
            for(let d=1; d<=days; d++) {
                const cellDate = new Date(y,m,d); const k = formatDateKey(cellDate); 
                const hasH = data[k]?.hours > 0, hasN = data[k]?.note || (data[k]?.bonuses?.length > 0);
                const cell = document.createElement('div');
                cell.className = `day-cell ${k === formatDateKey(new Date()) ? 'today' : ''} ${hasH ? 'has-hours' : ''}`;
                cell.onclick = () => openDailyModal(k);
                
                let inner = '';
                if(hasN) inner += `<div class="has-note-dot"></div>`;
                inner += `<div class="date-info"><b>${d}</b><span class="hebrew-date">${HebrewCal.format(cellDate)}</span></div>`;
                if(hasH) inner += `<div class="hours-display">${data[k].hours}×©'</div>`;
                cell.innerHTML = inner;
                grid.appendChild(cell);
            }
        }

        function openDailyModal(k) {
            selectedDate = new Date(k); const d = getWorkData()[k] || { hours:'', rate: getSettings().defaultRate, note:'', bonuses:[] };
            document.getElementById('modalTitle').textContent = k; document.getElementById('modalSubtitle').textContent = HebrewCal.format(selectedDate);
            document.getElementById('hoursInput').value = d.hours; document.getElementById('dayRateInput').value = d.rate; document.getElementById('dailyNote').value = d.note || '';
            const container = document.getElementById('bonusesContainer'); container.innerHTML = ''; (d.bonuses || []).forEach(b => addBonusRow(b.desc, b.amount));
            document.getElementById('hoursModal').classList.add('active');
        }

        function saveDailyData(close = true) {
            const data = getWorkData(), b = [];
            document.querySelectorAll('.bonus-row').forEach(row => {
                const desc = row.querySelector('.b-desc').value, amount = parseFloat(row.querySelector('.b-amount').value);
                if (amount > 0) b.push({ desc: desc || '×ª×•×¡×¤×ª', amount: amount });
            });
            data[formatDateKey(selectedDate)] = { 
                hours: parseFloat(document.getElementById('hoursInput').value) || 0,
                rate: parseFloat(document.getElementById('dayRateInput').value) || 0,
                note: document.getElementById('dailyNote').value, bonuses: b
            };
            setWorkData(data); if(close) closeModals(); renderMonthView(); updateReports(true); saveToDrive();
        }

        function addBonusRow(desc='', amount='') {
            const row = document.createElement('div'); row.className = 'bonus-row'; row.style.display='flex'; row.style.gap='5px'; row.style.marginTop='5px';
            row.innerHTML = `<input type="text" placeholder="×¡×™×‘×”/×¤×™×¨×•×˜" value="${desc}" class="b-desc" style="flex:2;"><input type="number" placeholder="â‚ª" value="${amount}" class="b-amount" style="flex:1;"><button onclick="this.parentElement.remove()" style="color:red; background:none; border:none;">X</button>`;
            document.getElementById('bonusesContainer').appendChild(row);
        }

        function openMagicModal(type) {
            multiActionType = type; const area = document.getElementById('multiModalInputArea');
            if(type === 'hours') {
                document.getElementById('multiModalTitle').textContent = 'âœ¨ ×”×—×œ×ª ×©×¢×•×ª';
                area.innerHTML = `<label>×©×¢×•×ª:</label><input type="number" id="multiValueInput" step="0.25">`;
            } else if(type === 'profit') {
                document.getElementById('multiModalTitle').textContent = 'ğŸ’° ×¨×•×•×— ×™×•××™ ×œ×ª×§×•×¤×”';
                area.innerHTML = `<label>×¡×›×•× (â‚ª):</label><input type="number" id="multiValueInput"><label style="margin-top:10px; display:block;">×ª×™××•×¨/×¡×™×‘×”:</label><input type="text" id="multiDescInput" placeholder="×œ××©×œ: × ×¡×™×¢×•×ª, ×‘×•× ×•×¡">`;
            } else if(type === 'rate') {
                document.getElementById('multiModalTitle').textContent = 'ğŸ’° ×ª×¢×¨×™×£ ××©×ª× ×”';
                area.innerHTML = `<label>×ª×¢×¨×™×£ (â‚ª):</label><input type="number" id="multiValueInput">`;
            }
            document.getElementById('multiDateModal').classList.add('active');
        }

        function executeMultiAction() {
            const val = parseFloat(document.getElementById('multiValueInput').value); if(!val) return;
            const dates = getDatesForRange(document.getElementById('multiDateRange').value, 'multiStart', 'multiEnd'); if(!dates) return;
            const data = getWorkData(), defRate = getSettings().defaultRate;
            dates.forEach(d => {
                const k = formatDateKey(d); if(!data[k]) data[k] = { hours:0, rate:defRate, bonuses:[], note:'' };
                if(multiActionType === 'hours') data[k].hours = val;
                else if(multiActionType === 'rate') data[k].rate = val;
                else if(multiActionType === 'profit') {
                    if(!data[k].bonuses) data[k].bonuses = [];
                    data[k].bonuses.push({ desc: document.getElementById('multiDescInput').value || '×ª×•×¡×¤×ª ×§×‘×•×¢×”', amount: val });
                }
            });
            setWorkData(data); closeModals(); renderMonthView(); updateReports(true); saveToDrive();
        }

        function updateReports(silent = true) {
            const period = document.getElementById('chartPeriod').value, pFilter = document.getElementById('profitFilter').value;
            let dates = (period === '7' || period === '14') ? [...Array(parseInt(period)).keys()].map(i => { const d = new Date(); d.setDate(d.getDate()-i); return d; }).reverse() : getDatesForRange(period, 'chartStart', 'chartEnd');
            if(!dates) return; const data = getWorkData(); let th = 0, tp = 0, labels = [], hData = [], pData = [];
            dates.forEach(d => {
                const k = formatDateKey(d); labels.push(`${d.getDate()}/${d.getMonth()+1}`);
                if(data[k]) {
                    const prof = calcDailyProfitDetails(data[k].hours, data[k].rate, data[k].bonuses);
                    th += data[k].hours; tp += prof.total; hData.push(data[k].hours);
                    pData.push(pFilter==='base'?prof.base:pFilter==='bonus'?prof.bonus:prof.total);
                } else { hData.push(0); pData.push(0); }
            });
            document.getElementById('reportSummary').innerHTML = `<div class="setting-group" style="flex:1; text-align:center; background:var(--primary-light); border:none;"><b>${th.toFixed(1)}</b><br>×©×¢×•×ª</div><div class="setting-group" style="flex:1; text-align:center; background:#d1fae5; border:none;"><b>â‚ª${tp.toFixed(0)}</b><br>×”×›× ×¡×”</div>`;
            if (hoursChart) hoursChart.destroy(); hoursChart = new Chart(document.getElementById('hoursChart'), { type: 'bar', data: { labels, datasets: [{ label: '×©×¢×•×ª', data: hData, backgroundColor: '#4f46e5' }] }, options: { responsive: true, maintainAspectRatio: false } });
            if (profitChart) profitChart.destroy(); profitChart = new Chart(document.getElementById('profitChart'), { type: 'line', data: { labels, datasets: [{ label: '×¨×•×•×—', data: pData, borderColor: '#10b981', fill: true }] }, options: { responsive: true, maintainAspectRatio: false } });
            updateComparisonChart(); renderMonthlyArchive();
        }

        function updateComparisonChart() {
            const grouping = document.getElementById('compGrouping').value, data = getWorkData(), groups = {};
            if (grouping === 'month') {
                Object.keys(data).forEach(k => {
                    const d = data[k], prof = calcDailyProfitDetails(d.hours, d.rate, d.bonuses), m = k.substring(0, 7);
                    groups[m] = (groups[m] || 0) + prof.total;
                });
            } else {
                const selMonth = document.getElementById('compMonthSelector').value;
                [1, 2, 3, 4].forEach(w => groups[`×©×‘×•×¢ ${w}`] = 0); 
                
                Object.keys(data).forEach(k => {
                    if (k.startsWith(selMonth)) {
                        const d = new Date(k), start = new Date(d.getFullYear(), d.getMonth(), 1);
                        let weekNum = Math.ceil(((d - start) / 86400000 + start.getDay() + 1) / 7);
                        if (weekNum > 4) weekNum = 4; 
                        const prof = calcDailyProfitDetails(data[k].hours, data[k].rate, data[k].bonuses), label = `×©×‘×•×¢ ${weekNum}`;
                        groups[label] = (groups[label] || 0) + prof.total;
                    }
                });
            }
            const labels = Object.keys(groups).sort(), vals = labels.map(l => groups[l]);
            if (comparisonChart) comparisonChart.destroy(); comparisonChart = new Chart(document.getElementById('comparisonChart'), { type: 'bar', data: { labels, datasets: [{ label: '×¨×•×•×—', data: vals, backgroundColor: '#4f46e5' }] }, options: { responsive: true, maintainAspectRatio: false } });
        }

        function renderMonthlyArchive() {
            const data = getWorkData(), m = {}, names = ['×™× ×•××¨','×¤×‘×¨×•××¨','××¨×¥','××¤×¨×™×œ','×××™','×™×•× ×™','×™×•×œ×™','××•×’×•×¡×˜','×¡×¤×˜××‘×¨','××•×§×˜×•×‘×¨','× ×•×‘××‘×¨','×“×¦××‘×¨'];
            Object.keys(data).forEach(k => {
                const mk = k.substring(0,7), d = data[k], p = calcDailyProfitDetails(d.hours, d.rate, d.bonuses);
                if(!m[mk]) m[mk]={h:0, p:0}; m[mk].h+=d.hours; m[mk].p+=p.total;
            });
            let h = '<h3 style="text-align:center; margin-top:20px;">ğŸ“… ××¨×›×™×•×Ÿ ×¡×™×›×•××™× ×—×•×“×©×™×™×</h3>';
            Object.keys(m).sort().reverse().forEach(mk => { 
                const [y, mon] = mk.split('-'); 
                h += `<div class="setting-group" style="display:flex; justify-content:space-between; align-items:center;">
                        <b>${names[parseInt(mon)-1]} ${y}</b>
                        <span style="font-size:14px;">×©×¢×•×ª: ${m[mk].h.toFixed(1)}</span>
                        <span style="color:var(--success); font-weight:bold;">×‘×¨×•×˜×•: â‚ª${m[mk].p.toFixed(0)}</span>
                      </div>`; 
            });
            document.getElementById('monthlyArchiveContainer').innerHTML = h;
        }

        async function executeSmartDelete() {
            const r = document.getElementById('deleteRange').value; 
            if (!r) return;
            
            if (confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ × ×ª×•× ×™× ××œ×• ×œ×¦××™×ª×•×ª?')) {
                let data = getWorkData();
                
                if (r === 'all') { 
                    localStorage.removeItem('workData'); 
                    setWorkData({}); 
                    await saveToDrive(); 
                    location.reload(); 
                    return; 
                }
                
                const dates = getDatesForRange(r, 'delStart', 'delEnd');
                if (dates && dates.length > 0) { 
                    dates.forEach(d => delete data[formatDateKey(d)]); 
                    setWorkData(data); 
                    renderMonthView(); 
                    updateReports(true); 
                    saveToDrive(); 
                    alert('×”× ×ª×•× ×™× × ××—×§×• ×‘×”×¦×œ×—×”.'); 
                }
            }
        }

        function switchTab(id) { document.querySelectorAll('.tab').forEach(t => t.classList.remove('active')); document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active')); document.getElementById(id).classList.add('active'); if(event) event.target.classList.add('active'); if(id === 'reports') updateReports(); }
        function closeModals() { document.querySelectorAll('.modal').forEach(m => m.classList.remove('active')); }
        function navigateMonth(d) { currentDate.setMonth(currentDate.getMonth()+d); renderMonthView(); }
        function jumpToToday() { currentDate = new Date(); renderMonthView(); }
        function jumpToDate() { const v = document.getElementById('jumpDateInput').value; if(v) { currentDate = new Date(v); renderMonthView(); } }
        function toggleMultiCustom() { document.getElementById('multiCustomDates').style.display = document.getElementById('multiDateRange').value === 'custom' ? 'block' : 'none'; }
        function toggleChartCustom() { document.getElementById('chartCustomDates').style.display = document.getElementById('chartPeriod').value === 'custom' ? 'block' : 'none'; }
        function toggleCompSelectors() { document.getElementById('compMonthArea').style.display = document.getElementById('compGrouping').value === 'week' ? 'block' : 'none'; }
        function toggleDeleteCustom() { document.getElementById('deleteCustomDates').style.display = document.getElementById('deleteRange').value === 'custom' ? 'block' : 'none'; }
        
        function getDatesForRange(r, s, e) {
            let start = new Date(), end = new Date(); const today = new Date();
            if(r === 'week') { start.setDate(today.getDate() - today.getDay()); end.setDate(start.getDate() + 6); }
            else if(r === 'month') { start = new Date(today.getFullYear(), today.getMonth(), 1); end = new Date(today.getFullYear(), today.getMonth()+1, 0); }
            else if(r === 'lastMonth') { start = new Date(today.getFullYear(), today.getMonth()-1, 1); end = new Date(today.getFullYear(), today.getMonth(), 0); }
            else if(r === 'custom') { start = new Date(document.getElementById(s).value); end = new Date(document.getElementById(e).value); }
            const res = []; for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) res.push(new Date(d)); return res;
        }

        function calcHoursFromTimes() { const s = document.getElementById('startTimeInput').value, e = document.getElementById('endTimeInput').value; if(s && e) { const [sh, sm] = s.split(':').map(Number), [eh, em] = e.split(':').map(Number); let d = (eh + em/60) - (sh + sm/60); if(d < 0) d += 24; document.getElementById('hoursInput').value = d.toFixed(2); } }
        function copyYesterdayHours() { const y = new Date(selectedDate); y.setDate(y.getDate()-1); const d = getWorkData()[formatDateKey(y)]; if(d) document.getElementById('hoursInput').value = d.hours; }
        function exportToCSV() { const d = getWorkData(); let c = '\uFEFF×ª××¨×™×š,×©×¢×•×ª,×ª×¢×¨×™×£,×¡×”"×›,×”×¢×¨×•×ª\n'; Object.keys(d).sort().forEach(k => { const r = d[k], p = calcDailyProfitDetails(r.hours, r.rate, r.bonuses); c += `${k},${r.hours},${r.rate},${p.total.toFixed(2)},${(r.note || '').replace(/,/g,' ')}\n`; }); const l = document.createElement('a'); l.href = URL.createObjectURL(new Blob([c], { type: 'text/csv' })); l.download = 'report.csv'; l.click(); }
        function initClock() { const start = localStorage.getItem('clockInTime'); if (start) { timerInterval = setInterval(updateTimerDisplay, 1000); updateTimerDisplay(); document.getElementById('clockBtn').textContent = 'â¹ï¸ ×¡×™×•× ××©××¨×ª'; } }
        function updateTimerDisplay() { const s = parseInt(localStorage.getItem('clockInTime')); if (!s) return; const diff = Math.floor((Date.now() - s) / 1000); const h = String(Math.floor(diff / 3600)).padStart(2, '0'), m = String(Math.floor((diff % 3600) / 60)).padStart(2, '0'), sec = String(diff % 60).padStart(2, '0'); document.getElementById('liveTimer').textContent = `${h}:${m}:${sec}`; }
        function handleClock() { const s = localStorage.getItem('clockInTime'); if (s) { clearInterval(timerInterval); const diff = (Date.now() - parseInt(s)) / (1000 * 60 * 60); localStorage.removeItem('clockInTime'); document.getElementById('clockBtn').textContent = 'â–¶ï¸ ×”×ª×—×œ ××©××¨×ª'; openDailyModal(formatDateKey(new Date()), diff.toFixed(2)); } else { localStorage.setItem('clockInTime', Date.now()); initClock(); } }
        function navigateModal(delta) { saveDailyData(false); selectedDate.setDate(selectedDate.getDate() + delta); openDailyModal(formatDateKey(selectedDate)); }
        function backupData() { const l = document.createElement('a'); l.href = URL.createObjectURL(new Blob([JSON.stringify({ workData: getWorkData(), settings: getSettings() })], { type: 'application/json' })); l.download = 'backup.json'; l.click(); }
        function restoreData(e) { const r = new FileReader(); r.onload = ev => { try { const p = JSON.parse(ev.target.result); if (p.workData) localStorage.setItem('workData', JSON.stringify(p.workData)); if (p.settings) localStorage.setItem('settings', JSON.stringify(p.settings)); location.reload(); } catch(err) { alert("×©×’×™××”!"); } }; r.readAsText(e.target.files[0]); }
    </script>
</body>
</html>
